services:
  secrets-init:
    image: alpine:3.20
    command: >
      sh -c '
        set -eu;
        gen() { head -c 32 /dev/urandom | base64 | tr -d "\n"; };
        mkdir -p /run/secrets;
        if [ ! -s /run/secrets/mariadb_root_password ]; then
          gen > /run/secrets/mariadb_root_password;
        fi
        if [ ! -s /run/secrets/moodle_db_password ]; then
          gen > /run/secrets/moodle_db_password;
        fi
        chmod 0400 /run/secrets/mariadb_root_password /run/secrets/moodle_db_password;
      '
    volumes:
      - secrets:/run/secrets
    restart: "no"
    networks:
      - backend

  mariadb:
    image: ${MARIADB_IMAGE?Set MARIADB_IMAGE}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    environment:
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/mariadb_root_password
      MARIADB_DATABASE: moodle
      MARIADB_USER: moodle
      MARIADB_PASSWORD_FILE: /run/secrets/moodle_db_password
    volumes:
      - mariadb_data:/var/lib/mysql
      - secrets:/run/secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "mariadb-admin ping -h localhost -p\"$(cat /run/secrets/mariadb_root_password)\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      secrets-init:
        condition: service_completed_successfully
    networks:
      - backend

  maxima:
    image: ${GOEMAXIMA_IMAGE?Set GOEMAXIMA_IMAGE}
    networks:
      - backend

  moodle:
    image: docker-moodle-stack-goemaxima-moodle
    build:
      context: .
      dockerfile: docker/moodle/Dockerfile
      args:
        MOODLE_PHP_BASE_IMAGE: ${MOODLE_PHP_BASE_IMAGE?Set MOODLE_PHP_BASE_IMAGE}
        MOODLE_RELEASE_URL: ${MOODLE_RELEASE_URL?Set MOODLE_RELEASE_URL}
        MOODLE_RELEASE_SHA256: ${MOODLE_RELEASE_SHA256?Set MOODLE_RELEASE_SHA256}
        STACK_PLUGIN_URL: ${MOODLE_STACK_PLUGIN_URL?Set MOODLE_STACK_PLUGIN_URL}
        STACK_PLUGIN_SHA256: ${MOODLE_STACK_PLUGIN_SHA256?Set MOODLE_STACK_PLUGIN_SHA256}
        STACK_BEHAVIOUR_DFEXPLICIT_URL: ${MOODLE_STACK_BEHAVIOUR_DFEXPLICIT_URL?Set MOODLE_STACK_BEHAVIOUR_DFEXPLICIT_URL}
        STACK_BEHAVIOUR_DFEXPLICIT_SHA256: ${MOODLE_STACK_BEHAVIOUR_DFEXPLICIT_SHA256?Set MOODLE_STACK_BEHAVIOUR_DFEXPLICIT_SHA256}
        STACK_BEHAVIOUR_DFCBMEXPLICIT_URL: ${MOODLE_STACK_BEHAVIOUR_DFCBMEXPLICIT_URL?Set MOODLE_STACK_BEHAVIOUR_DFCBMEXPLICIT_URL}
        STACK_BEHAVIOUR_DFCBMEXPLICIT_SHA256: ${MOODLE_STACK_BEHAVIOUR_DFCBMEXPLICIT_SHA256?Set MOODLE_STACK_BEHAVIOUR_DFCBMEXPLICIT_SHA256}
        STACK_BEHAVIOUR_ADAPTIVEMULTIPART_URL: ${MOODLE_STACK_BEHAVIOUR_ADAPTIVEMULTIPART_URL?Set MOODLE_STACK_BEHAVIOUR_ADAPTIVEMULTIPART_URL}
        STACK_BEHAVIOUR_ADAPTIVEMULTIPART_SHA256: ${MOODLE_STACK_BEHAVIOUR_ADAPTIVEMULTIPART_SHA256?Set MOODLE_STACK_BEHAVIOUR_ADAPTIVEMULTIPART_SHA256}
    environment:
      MOODLE_DB_HOST: mariadb
      MOODLE_DB_NAME: moodle
      MOODLE_DB_USER: moodle
      MOODLE_DB_PASSWORD_FILE: /run/secrets/moodle_db_password
      MOODLE_DATA_DIR: /var/www/moodledata
    volumes:
      - moodledata:/var/www/moodledata
      - secrets:/run/secrets:ro
    ports:
      - "${MOODLE_HTTP_PORT:-8080}:80"
    depends_on:
      mariadb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost/login/index.php"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - backend
      - frontend

  moodle-cron:
    image: docker-moodle-stack-goemaxima-moodle
    command: ["cron", "-f"]
    volumes:
      - moodledata:/var/www/moodledata
    depends_on:
      moodle:
        condition: service_healthy
    networks:
      - backend

volumes:
  mariadb_data:
  moodledata:
  secrets:

networks:
  backend:
    internal: true
  frontend:
